# ゲームルール仕様書

## 基本ルール

### 盤面構成
- **表示盤面**: 6列×12行のグリッド
- **実際盤面**: 6列×13行（13行目は非表示の隠し段）
- **13段目への設置方法**:
  - まわし（回転操作）を利用
  - 11段目のぷよの上にツモを縦向きに配置

### ぷよの基本要素
- **ぷよの色**: 4色（赤、青、緑、黄）+ おじゃまぷよ（色なし）
- **落下単位**: 2個ペアで落下
- **ネクスト**: 次の2つのペア（ネクスト、ネクネク）を事前表示

## 操作仕様

### 基本操作
- **左移動**: Left Arrow, A
- **右移動**: Right Arrow, D
- **ソフトドロップ**: Down Arrow, Space, S
- **右回転**: L
- **左回転**: K
- **ポーズ**: ESC, P

### 回転ルール
- ぷよペアは4つの向きに回転可能
- 回転時に他のぷよ・壁に接触する場合は回転不可
- 縦向き＋左右接触時: 回転入力2回で上下入れ替え可能
- 回転に関わらずぷよは自動落下継続

### 落下・着地ルール
- **自動落下**: 一定時間間隔で1行ずつ落下
- **ハードドロップ禁止**: 即座落下不可、速度アップのみ可能
- **着地判定**: 他のぷよ・盤面底への接触
- **ちぎれ**: 横向き片方着地時、もう片方は独立落下継続

## 消去・連鎖システム

### 消去条件
- **基本消去**: 同色4個以上の連結で消去
- **連鎖発生**: 消去後の落下で新たな連結→次の連鎖
- **連鎖中制限**: 新しいぷよは落下停止

### 得点計算
**基本式**: （得点）＝（消去得点）＋（全消し得点）＋（落下得点）

**消去得点**: （ぷよ消去数）×10×（（連鎖ボーナス）＋（多色ボーナス）＋（連結ボーナス））

#### 連鎖ボーナス表
| 連鎖数 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 |
|--------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|----|----|----|----|
| ボーナス | 0 | 8 |16 | 32 | 64 | 96 | 128 | 160 | 192 | 224 | 256 | 288 | 320 | 352 | 384 | 416 | 448 | 480 | 512 |

#### 連結ボーナス表
| 同時消去数 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11以上 |
|------------|---|---|---|---|---|---|----|----|
| ボーナス | 0 | 2 | 3 | 4 | 5 | 6 | 7 | 10 |

#### 多色ボーナス表
| 色数 | 1 | 2 | 3 | 4 |
|------|---|---|---|---|
| ボーナス | 0 | 3 | 6 | 12 |

### ゲームオーバー条件
- ぷよが盤面上部 x=2 または x=3 まで積み上がる

## 対戦ルール

### プレイヤー構成
- **プレイヤーA（1P）**: 左側盤面
- **プレイヤーB（2P）**: 右側盤面
- **プレイヤータイプ**: 「人間プレイヤー」または「無能CPU」

### ツモ共有システム
- 両プレイヤーは**同じ乱数シード**でぷよペア生成
- 同じ順序のぷよペアが各プレイヤーに供給
- 操作・盤面状態は完全に独立

### おじゃまぷよシステム

#### 基本仕様
- **発生条件**: 連鎖でスコア獲得時、相手におじゃまぷよ送信
- **変換レート**: 70点ごとに1個（端数切り捨て）
- **例**: 70～139点 → 1個、140～209点 → 2個

#### おじゃまぷよの種類（表示用）
- **小おじゃまぷよ** ○: 1個分
- **大おじゃまぷよ** ●: 6個分  
- **岩おじゃまぷよ** ◆: 30個分
- **表示ルール**: 大きいものから左詰め（例: ◆●○○）

#### 降下ルール
- **降下タイミング**: 相手のぷよ着地後
- **降下制限**: 一度に最大5段分（30個）まで降下
- **残留処理**: 5段降らせてもおじゃまが残る場合、次回着地時に継続降下
- **降下分配**: 各列に均等分配（余りはランダム）
- **実体**: 実際に降るのは小おじゃまぷよのみ
- **蓄積**: 複数連鎖分をまとめて降下

### 連鎖中の操作制御
- **A連鎖中**: A操作無効、B操作有効
- **B連鎖中**: A操作有効、B操作無効  
- **非連鎖時**: 両プレイヤー操作有効

### 対戦終了条件
- **基本**: いずれかがゲームオーバーで敗北
- **同時**: 先にゲームオーバーになった方が敗北
- **連鎖中**: 連鎖描画終了後にゲームオーバー判定

## 無能CPU仕様

### 思考アルゴリズム
- **基本戦略**: 最も深い谷に回転なしで落下
- **探索方式**: 各列の深度計算→最深列選択
- **連鎖無視**: 連鎖は狙わず単純積み上げ
- **操作方式**: 仮想ゲームコントローラ経由

### AI拡張予定
- **DQNプレイヤー**: 機械学習による最適手選択
- **学習環境**: AI同士の高速対戦
- **評価指標**: スコア・生存時間・連鎖数等の複合評価