# ぷよぷよ 画面状態遷移仕様書

## 画面構成

### 1. メイン画面
- ゲームのメインメニュー画面
- シングルプレイ、対戦モード、設定へのボタン
- タイトルロゴなし

### 2. プレイヤー選択画面（対戦モード用）
- プレイヤーA用ドロップダウンメニュー
- プレイヤーB用ドロップダウンメニュー  
- 選択肢：「人間プレイヤー」「無能CPU」
- ゲーム開始ボタン
- 戻るボタン

### 3. ゲーム画面（シングルプレイ）
- 盤面（6列12行）
- 落下中のぷよペア
- ネクスト・ネクネク表示（次の2つのぷよペア）
- スコア表示
- ポーズボタン

### 4. ゲーム画面（対戦モード）
- プレイヤーA盤面（左側、6列12行）
- プレイヤーB盤面（右側、6列12行）
- 各プレイヤーの落下中ぷよペア
- 各プレイヤーのネクスト・ネクネク表示
- 各プレイヤーのスコア表示
- おじゃまぷよ予告表示（両プレイヤー）
- ポーズボタン

### 5. ポーズ画面
- 「ゲームを続ける」ボタン
- 「メインメニューに戻る」ボタン
- 背景は半透明でゲーム画面が見える状態

### 6. ゲームオーバー画面
- 結果表示（勝者、最終スコア）
- シングルプレイの場合：最終スコア
- 対戦の場合：勝者表示とスコア比較
- 「リトライ」ボタン
- 「メインメニューに戻る」ボタン

## 状態遷移図

```
メイン画面
├── [シングルプレイボタン] → ゲーム画面（シングルプレイ）
├── [対戦モードボタン] → プレイヤー選択画面
└── [設定ボタン] → 設定画面（未実装）

プレイヤー選択画面
├── [ゲーム開始ボタン] → ゲーム画面（対戦モード）
└── [戻るボタン] → メイン画面

ゲーム画面（シングルプレイ）
├── [ポーズボタン/ESC] → ポーズ画面
└── [ゲームオーバー条件] → ゲームオーバー画面

ゲーム画面（対戦モード）  
├── [ポーズボタン/ESC] → ポーズ画面
└── [ゲームオーバー条件] → ゲームオーバー画面

ポーズ画面
├── [ゲームを続ける] → ゲーム画面（元の画面に戻る）
└── [メインメニューに戻る] → メイン画面

ゲームオーバー画面
├── [リトライ] → ゲーム画面（同じモードで再開）
└── [メインメニューに戻る] → メイン画面
```

## 画面レイアウト詳細

### シングルプレイ画面
```
┌─────────────────────────────────────────────┐
│               PUYO PUYO                     │
│                                             │
│               SCORE: 123,456                │
├─────────────────────────────────────────────┤
│                                             │
│ ┌─────────────────────┐            NEXT    │
│ │                     │           ┌───┐   │
│ │      ゲーム盤面      │           │ R │   │
│ │     (6列x12行)      │           │ G │   │
│ │                     │           └───┘   │
│ │                     │           NEXT2   │
│ │                     │           ┌───┐   │
│ │                     │           │ B │   │
│ └─────────────────────┘           │ Y │   │
│                                   └───┘   │
│                                            │
│                                            │
│                                            │
│                   [PAUSE]                  │
└─────────────────────────────────────────────┘
```

### 対戦モード画面
```
┌─────────────────────────────────────────────────────────────────┐
│                           PUYO PUYO VS                         │
│                                                                 │
│ 1P: 123,456                                    2P: 789,012     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ おじゃま予告: ◆●○○                    おじゃま予告: ○○○       │
│                                                                 │
│ ┌─────────────────┐ NEXT      NEXT    ┌─────────────────┐     │
│ │                 │┌───┐    ┌───┐    │                 │     │
│ │   プレイヤーA     ││ R │    │ R │    │   プレイヤーB     │     │
│ │     盤面        ││ G │    │ G │    │     盤面        │     │
│ │  (6列x12行)     │└───┘    └───┘    │  (6列x12行)     │     │
│ │                 │NEXT2             │                 │     │
│ │                 │┌───┐             │                 │     │
│ │                 ││ B │             │                 │     │
│ │                 ││ Y │             │                 │     │
│ └─────────────────┘└───┘             └─────────────────┘     │
│                                                               │
│                          [PAUSE]                             │
└─────────────────────────────────────────────────────────────────┘
```

## UI要素の詳細

### ぷよの色表現
- **赤ぷよ**：R（赤色背景）
- **青ぷよ**：B（青色背景）  
- **緑ぷよ**：G（緑色背景）
- **黄ぷよ**：Y（黄色背景）
- **おじゃまぷよ**：×（灰色背景）

### おじゃまぷよ予告表示
- **小おじゃまぷよ**：○（1個分）
- **大おじゃまぷよ**：●（6個分）
- **岩おじゃまぷよ**：◆（30個分）
- 大きいおじゃまぷよを左詰めで表示
- 例：「◆●○○」= 岩1個 + 大1個 + 小2個 = 38個のおじゃまぷよ予告

### ネクスト表示
```
NEXT     NEXT2
┌───┐   ┌───┐
│ R │   │ B │  ← 上のぷよ
│ G │   │ Y │  ← 下のぷよ  
└───┘   └───┘
```

### プレイヤー選択画面レイアウト
```
┌─────────────────────────────────────┐
│             PLAYER SELECT           │
├─────────────────────────────────────┤
│                                     │
│  プレイヤーA: [人間プレイヤー ▼]    │
│                                     │
│           VS                        │
│                                     │
│  プレイヤーB: [無能CPU ▼]          │
│                                     │
│                                     │
│     [ゲーム開始]    [戻る]          │
│                                     │
└─────────────────────────────────────┘
```

## アニメーション・エフェクト

### 連鎖エフェクト (この辺はあとで調整の可能性あり)
1. **消去予告**：対象ぷよが0.1秒間点滅
2. **消去実行**：ぷよがフェードアウト（0.1秒）
3. **落下**：上にあるぷよが重力で落下（１マスにつき0.1秒）
4. **次判定**：新しい連結チェック → 次の連鎖へ

### おじゃまぷよ落下エフェクト
1. **予告表示更新**：おじゃま予告から実際のぷよに変換
2. **落下アニメーション**：上から各列に振り分けて落下
3. **着地**：既存のぷよの上に積み上がり

### ゲームオーバーエフェクト
1. **警告表示**：ゲームオーバーライン（x=2,3 and y=12）到達時に点滅
2. **盤面停止**：全ての動作を停止
3. **結果表示**：1秒後にゲームオーバー画面へ遷移

## 操作・入力仕様

### ゲーム中のキーボード操作
- **左移動**：Left Arrow, A
- **右移動**：Right Arrow, D
- **ソフトドロップ**：Down Arrow, Space, S
- **右回転**：L
- **左回転**：K  
- **ポーズ**：ESC, P

### 対戦モードでの同時入力
- 両プレイヤーが人間の場合、同じキーボードで同時操作
- 入力の優先度や衝突処理は不要（各プレイヤー独立盤面のため）

### マウス操作
- メニュー画面でのボタンクリック
- ドロップダウンメニューの選択
- ゲーム中はキーボード操作のみ

## ゲーム状態管理

### アプリケーション状態
```javascript
enum AppState {
  MAIN_MENU,        // メイン画面
  PLAYER_SELECT,    // プレイヤー選択画面  
  GAME_SINGLE,      // シングルプレイ中
  GAME_VERSUS,      // 対戦モード中
  PAUSED,           // ポーズ中
  GAME_OVER         // ゲームオーバー
}
```

### ゲーム内状態（各プレイヤー独立）
```javascript
type PlayerState = {
  board: Color[][];              // 盤面状態（6x12）
  fallingPuyo: PuyoPair | null;  // 落下中ぷよペア
  nextPuyos: PuyoPair[];         // ネクスト・ネクネク
  score: number;                 // スコア
  isChaining: boolean;           // 連鎖中フラグ
  ojamaPending: number;          // 待機中おじゃまぷよ数
}
```

### プレイヤータイプ
```javascript
enum PlayerType {
  HUMAN,      // 人間プレイヤー
  CPU_WEAK    // 無能CPU
}
```

### 連鎖中の操作制御
- **自分の連鎖中**：自分の操作無効、相手の操作有効
- **相手の連鎖中**：自分の操作有効、相手の操作無効
- **両方非連鎖中**：両方の操作有効

## 技術実装上の考慮点

### ツモ（ぷよペア）の同期
- 対戦開始時に共通の乱数シードを設定
- 両プレイヤーで同じ順序のぷよペアが生成される
- 各プレイヤーの消費タイミングは独立

### おじゃまぷよのタイミング制御
- 相手の連鎖終了 → おじゃま計算 → 自分のぷよ着地後に降下
- 複数回の連鎖で蓄積されたおじゃまは一度にまとめて降下

### パフォーマンス最適化
- 盤面描画は差分更新
- アニメーション中は入力バッファリング
- 連鎖計算は非同期処理で UI をブロックしない
