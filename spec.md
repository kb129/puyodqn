# ぷよぷよ
本家のぷよぷよをコピーした実装をするための仕様書。

## 将来予定している機能
### AIによる最適手の学習
- 機械学習を用いて、最適なぷよの配置を学習する機能を実装予定。
    - ゲームの操作をプレイヤーと揃えるため、仮想入力での操作を想定した実装にすること。
- AI同士の同時学習
    - 複数のAIが同時に学習を行い、互いに競い合うことで効率的な学習を実現する。
    - ゲームスピードの変更が可能な実装にすること。


## 基本ルール

### ゲームオーバー
- ぷよが盤面の上部x=2 or 3  (x軸；横軸は0始まり)まで積み上がるとゲームオーバーとなる。

### ぷよの連鎖
- ぷよが4つ以上同じ色で連結すると消える。
- 連鎖の描画中は新しいぷよは落ちてこない。

### 盤面
- 盤面は6列12行のグリッドで構成される。
- 実際には13行目（非表示行）が存在し、回転操作によって13段目にぷよを設置することが可能。
- 13段目への設置は以下の方法で行う：
  - まわし（回転操作）を利用する
  - 11段目のぷよの上にツモを縦向きに配置する
- ぷよは4つの色（赤、青、緑、黄）があり、各ぷよは1つの色を持つ。
- ぷよは2つずつペアで落ちてくる。

### ぷよの操作
- プレイヤーはぷよのペアを回転させたり、左右に移動させたりして配置する。
- ぷよは一定の時間間隔で自動的に1行ずつ落下する。
- プレイヤーはぷよを即座に落下させることはできない（ハードドロップの禁止）が、落下速度を速めることはできる。

### ぷよの着地
- ぷよが他のぷよまたは盤面の底に接触すると着地する。
- 着地したぷよはその位置に固定される。
    - 横向きに片方のぷよが着地した場合、もう片方のぷよはちぎれて独立に落下を続ける。このとき、もう片方のぷよが他のぷよまたは盤面の底に接触すると着地する。

### ぷよの回転
- ぷよのペアは4つの向き（右回り、左回り）に回転できる。
- 回転時にぷよが他のぷよや盤面の壁に接触する場合、回転は行われない。
- 縦向きかつ、左右を他のぷよに接触している場合は、回転入力を一定の時間内に2回行うことで上下の入れ替えのみ可能。
- 回転入力の有無にかかわらずぷよは自動的に落下し続け、着地して一定時間後に固定される。

### ぷよの落下速度
- ぷよの落下速度はゲームの進行にかかわらず一定である。
- (Todo)将来のAIによる学習では、ゲームスピードは何段階化で変更可能な実装をする。


### 消去と得点
- ぷよが4つ以上連結して消えると得点が加算される。
- 連鎖が続くと得点が増加する。
- 連鎖数や同時消去数に応じてボーナス得点が加算される。

- （得点）＝（消去得点）＋（全消し得点）＋（落下得点）
- （消去得点）＝（ぷよ消去数）×10×（（連鎖ボーナス）＋（多色ボーナス）＋（連結ボーナス））
- （ぷよ消去数）は、色ぷよの消えた数である（４つで消えるので、通常ルールでは４以上）。
- （連鎖ボーナス）＝∑（連鎖中の１連鎖ごとの消去得点）
    - 盤面から、原理的に可能な連鎖数の上限は19であり、19連鎖までの連鎖ボーナスは以下の表の通り
    | 連鎖数 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 |
    |--------|---|---|---|---|---|---|---|---|---|----|----|----|----|----|----|----|----|----|----|
    | 連鎖ボーナス | 0 | 8 |16 | 32 | 64 | 96 | 128 | 160 | 192 || 224 | 256 | 288 | 320 | 352 | 384 | | 416 | 448 | 480 | 512 |
- 連結ボーナスは、同時に消えた色ぷよの数に応じて以下の通り
    | 同時消去数 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11以上 |
    |------------|---|---|---|---|---|---|-------|----|
    | 多連結ボーナス | 0 | 2 | 3 | 4 | 5 | 6 | 7 | | 10 |
- 多色ボーナスは、同時に消えた色ぷよの種類に応じて以下の通り
    | 色数 | 1 | 2 | 3 | 4 | 5 |
    |------|---|---|---|---|---|
    | 多色ボーナス | 0 | 3 | 6 | 12 | 24 |

- 得点計算の詳細なルールは以下の通り：
  - 基本得点：4つのぷよが消えるごとに100点。
  - 追加得点：5つ目以降のぷよが消えるごとに50点追加。
  - 連鎖ボーナス：連鎖数に応じて得点が倍増（2連鎖で2倍、3連鎖で3倍、...）。
  - 同時消去ボーナス：同時に消えたぷよの数に応じて追加得点（5個で200点、6個で300点、...）。

### 次のぷよ
- 次に落ちてくるぷよのペアは事前に2つ表示される。（ネクスト、ネクネク）

## 対戦ルール（二人）
### おじゃまぷよ
- この仕様書では操作プレイヤーを「自分」、1P、プレイヤーA、または単に「A」、対戦相手を「相手」、2P、「プレイヤーB」、または単に「B」と呼ぶ。
- プレイヤーが連鎖を発生させると、相手の盤面におじゃまぷよが降ってくる。
- おじゃまぷよは色がなく、連結しても消えない。
- おじゃまぷよの数は、現在の連鎖で獲得したスコアによって決まり、おじゃまぷよの数は70点ごとに1個降ってくる。(端数切り捨て)
    - 例：一度の連鎖で70点〜139点までのスコア獲得した場合、1個のおじゃまぷよが降ってくる。
- おじゃまぷよの降ってくる位置は各列に均等に分配されるが、列数で割り切れない場合はランダムに割り当てられる。
- おじゃまぷよは相手の盤面の一番上部から降ってくきて、、既にぷよがある場合はその上に積み上がる。
- おじゃまぷよには種類があり、「小おじゃまぷよ」（1個分）、「大おじゃまぷよ」（1列分；小おじゃまぷよ6個分）、「岩おじゃまぷよ」（5列分；小おじゃまぷよ30個分）がある。
- 表示としては種類があるが、実際に降ってくるおじゃまぷよは「小おじゃまぷよ」のみである。
- 相手プレイヤーが連鎖で大おじゃまぷよ以上の大きさのおじゃまぷよを獲得した場合、相手プレイヤーの盤面に降ってくるおじゃまぷよは以下のルールで決定される。
    - 獲得たおじゃまぷよが30個以上の場合、まず5列分の小おじゃまぷよを降らせ、累積おじゃまぷよ数から30個を引く。
    - 30個未満の場合、すべてのおじゃまぷよを小おじゃまぷよとして扱い、累積おじゃまぷよ数から引く。
    - これを繰り返し、最後に残ったおじゃまぷよの数が5個以下の場合は「小おじゃまぷよ」が降ってくる。
- 相手プレイヤーが発生させたおじゃまぷよは、自分が操作しているぷよが着地したあとのタイミングで降ってくる。
    - 相手プレイヤーが連続して連鎖を発生させた場合、それぞれの連鎖で獲得したおじゃまぷよはまとめて降ってくるが、自分が操作しているぷよが着地したあとのタイミングで降ってくる。
        1. 自分が操作しているぷよが着地する間に相手プレイヤーが発生させたおじゃまぷよは、まとめて自分の盤面に降ってくる。
        2. 自分が操作しているぷよが着地するタイミングで相手プレイヤーが連鎖を発生させている途中の場合は着地までにに発生したおじゃまぷよだけが降って来たあとに、相手の連鎖が終了後、改めて自分が操作しているぷよが着地したタイミングで残りのおじゃまぷよが降ってくる。

### 無能CPU
- 対戦相手が無能CPUの場合、無能CPUはぷよを最も深い谷に回転なしで落とす。（探索アルゴリズム実装）
- 無能CPUは連鎖を狙わず、単にぷよを積み上げるだけの動作を行う。
- 無能CPUはおじゃまぷよを送る。
- 無能CPUも仮想ゲームコントローラでの操作を行う。

### プレイヤー選択
- プレイヤーA、Bは対戦開始前にそれぞれドロップダウンメニューから選択できる。
    - つまり、ドロップダウンメニューが2つ存在し、それぞれがプレイヤーA、Bに対応する。
- プレイヤーA、Bはそれぞれ「人間プレイヤー」または「無能CPU」を選択できる。
- 両方とも「人間プレイヤー」が選択された場合、全く同じ入力で操作される。

### ツモの共有
- プレイヤーA、Bは同じ順番で落ちてくるぷよのペアを共有する。
- つまり、プレイヤーA、Bは同じ乱数シードを用いて生成されたぷよのペアが落ちてくる。
    - 操作はそれぞれ独立して行われ、盤面およびネクスト、ネクネクまでの状態も独立している。
    - ぷよのペアの生成は、対戦開始前に決定された乱数シードに基づいて行われる。
    - つまり、プレイヤーA、Bは同じ順番で落ちてくるぷよのペアを共有するが、操作はそれぞれ独立して行われる。

### 連鎖中の動作
- 連鎖の描画中は新しいぷよは落ちてこない。
- Aの連鎖中にAが操作を行っても操作は反映されない。
- Bの連鎖中にBが操作を行っても操作は反映されない。
- Aの連鎖中にBが操作を行った場合、Bの操作は反映される。
- Bの連鎖中にAが操作を行った場合、Aの操作は反映される。

### ゲームオーバー
- どちらかのプレイヤーの盤面がゲームオーバーになると、そのプレイヤーの負けとなる。
- 両方のプレイヤーが同時にゲームオーバーになった場合はさきにゲームオーバーになったプレイヤーの負けとなる。
- A（またはB）の連鎖の描画中におじゃまぷよが降ってきてB（またはA）がゲームオーバーになる場合は、A（またはB）の連鎖の描画が終了した後にゲームオーバーとなる。

### 対戦時間
- 対戦時間による制限はない。


## キー設定
- 左移動：Left Arrow, A
- 右移動：Right Arrow, D
- 下移動：Down Arrow, Space, S
- 右回転：L
- 左回転：K
